<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Theory · NMRInversions.jl</title><meta name="title" content="Theory · NMRInversions.jl"/><meta property="og:title" content="Theory · NMRInversions.jl"/><meta property="twitter:title" content="Theory · NMRInversions.jl"/><meta name="description" content="Documentation for NMRInversions.jl."/><meta property="og:description" content="Documentation for NMRInversions.jl."/><meta property="twitter:description" content="Documentation for NMRInversions.jl."/><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../search_index.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script><link href="../assets/citations.css" rel="stylesheet" type="text/css"/></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../"><img src="../assets/logo.svg" alt="NMRInversions.jl logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../">NMRInversions.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../">Overview</a></li><li><a class="tocitem" href="../installation/">Installation</a></li><li class="is-active"><a class="tocitem" href>Theory</a><ul class="internal"><li><a class="tocitem" href="#Exponentials-in-NMR"><span>Exponentials in NMR</span></a></li><li><a class="tocitem" href="#Multi-exponential-forms"><span>Multi-exponential forms</span></a></li><li><a class="tocitem" href="#Exponential-fits"><span>Exponential fits</span></a></li><li><a class="tocitem" href="#Inversions"><span>Inversions</span></a></li></ul></li><li><a class="tocitem" href="../tutorial/">Tutorial</a></li><li><a class="tocitem" href="../functions/">Functions</a></li><li><a class="tocitem" href="../types_structs/">Types and Structures</a></li><li><a class="tocitem" href="../savefiles/">Saving data</a></li><li><a class="tocitem" href="../references/">References</a></li><li><a class="tocitem" href="../contributing/">Contributing</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>Theory</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Theory</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/aris-mav/NMRInversions.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/aris-mav/NMRInversions.jl/blob/master/docs/src/theory.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><p>What follows is a rough explanation of what this package is about. If you&#39;re looking for more rigor, please refer to sources  [<a href="../references/#Hansen2010">1</a>–<a href="../references/#Venka2002">4</a>] in the  <a href="../references/">References</a> section. If you believe something mentioned below is wrong or misleading, please <a href="https://github.com/arismavridis/NMRInversions.jl/issues/new">submit an issue</a>.</p><h2 id="Exponentials-in-NMR"><a class="docs-heading-anchor" href="#Exponentials-in-NMR">Exponentials in NMR</a><a id="Exponentials-in-NMR-1"></a><a class="docs-heading-anchor-permalink" href="#Exponentials-in-NMR" title="Permalink"></a></h2><p>For NMR relaxation and diffusion experiments in liquids, we expect the results we get to look more or less like an exponential decay  or recovery, as described by the BPP theory [<a href="../references/#BPP">5</a>].</p><p>To obtain useful information from NMR experiments, we can use different  exponential forms, according to the pulse sequence used.</p><p>Examples are : </p><table><tr><th style="text-align: right">Pulse sequence</th><th style="text-align: left">Equation</th></tr><tr><td style="text-align: right">Inversion recovery</td><td style="text-align: left"><span>$M = 1 - 2( \exp(-t/T_1) )$</span></td></tr><tr><td style="text-align: right">Saturation recovery</td><td style="text-align: left"><span>$M = 1 - \exp(-t/T_1)$</span></td></tr><tr><td style="text-align: right">CPMG</td><td style="text-align: left"><span>$M = \exp(-t/T_2)$</span></td></tr><tr><td style="text-align: right">PGSE</td><td style="text-align: left"><span>$M = \exp(-b * D)$</span></td></tr></table><p>, where <span>$M$</span> is the magnetization (the &quot;signal&quot; you would record in such an  experiment, normalized so that its maximum value is 1), <span>$t$</span> is time, <span>$T_1$</span>  and <span>$T_2$</span> are relaxation time constants, <span>$b$</span> is the b-factor in the  Stejskal-Tanner equations, and <span>$D$</span> is diffusion coefficient.</p><p>This is all good if the sample you want to study is nice and simple  (e.g., a liquid made up of a single type of molecule), and you can fit your   data using the equations above to obtain the desired quantity, which would be  either <span>$T_1$</span>, <span>$T_2$</span>, or <span>$D$</span>. </p><h2 id="Multi-exponential-forms"><a class="docs-heading-anchor" href="#Multi-exponential-forms">Multi-exponential forms</a><a id="Multi-exponential-forms-1"></a><a class="docs-heading-anchor-permalink" href="#Multi-exponential-forms" title="Permalink"></a></h2><p>If the NMR data comes from a system which is to some degree inhomogenous, e.g. has multiple pore environments, several different liquids, etc.,  we would expect for the data to be a sum of exponentials, one for each of the underlying components.</p><p>For example, if we do a CPMG experiment on a mixture of water and ethanol, we would expect the equation to look like :</p><p class="math-container">\[M = \alpha \exp(-t/T_{2, water}) + \beta \exp(-t/T_{2, ethanol}) \ ,\]</p><p>where <span>$\alpha$</span> and <span>$\beta$</span> would represent the fractions of  water and ethanol spins into the system, respectively.</p><p>Of course, there&#39;s no reason to stop at two components. The more general form could be written as :</p><p class="math-container">\[M = \sum_{k=1}^n f_k \exp(-t/T_{2,k}) \ ,\]</p><p>where <span>$n$</span> is the total number of different components hidden behind the data, and <span>$f_k$</span> is the fraction of the <span>$k$</span>th component.</p><h2 id="Exponential-fits"><a class="docs-heading-anchor" href="#Exponential-fits">Exponential fits</a><a id="Exponential-fits-1"></a><a class="docs-heading-anchor-permalink" href="#Exponential-fits" title="Permalink"></a></h2><p>Normally, we would use some type of <a href="https://en.wikipedia.org/wiki/Nonlinear_regression">nonlinear regression</a> to handle cases where we already know that the system we  study is made up of a limited number of components  (<span>$n$</span> would be 1,2 or maybe 3).  This package covers this case using the <code>expfit(n, data)</code> function.</p><p>However, in a lot of realistic scenarios, this method fails for a few reasons:</p><ul><li>We don&#39;t always know exactly how many components our system is made out of.</li><li>There might be a virtually continuous range of relaxation times (or diffusion  coefficients) within the system, e.g. a fluid within a rock sample with  many different pore sizes might have a different relaxation time for each pore size.</li><li>When we add too many degrees of freedom by introducing lots of free  variables in the fit equation, it&#39;s easy for the algorithm to converge in nonsensical values which just happen to be close to the starting points  and yield a low-enough value for the cost function. The fit could be satisfying, but the values might be unrealistic and unreliable.</li></ul><h2 id="Inversions"><a class="docs-heading-anchor" href="#Inversions">Inversions</a><a id="Inversions-1"></a><a class="docs-heading-anchor-permalink" href="#Inversions" title="Permalink"></a></h2><p>In linear algebra terms, a discrete version of the equation :</p><p class="math-container">\[M = \sum_{k=1}^n f_k \exp(-t/T_{2,k})  \ ,\]</p><p>can be written as :</p><p class="math-container">\[Kf = g \ ,\]</p><p>where :</p><ul><li><span>$g$</span> is a vector containing the <span>$M$</span> values recorded from an experiment,</li><li><span>$f$</span> is a vector containing the <span>$f_k$</span> values present in the system,</li><li><span>$K$</span> is a &quot;kernel&quot; matrix, which can be constructed for a predetermined, usually logarithmically-spaced range of <span>$T_2$</span> values.</li></ul><p>What we are interested in is to solve for the <span>$f$</span> vector, since  <span>$g$</span> is already known and <span>$K$</span> can be constructed according to the range of  <span>$T_2$</span> values we&#39;re looking for (or <span>$T_1$</span>, or <span>$D$</span>).</p><p>The &quot;naive&quot; way to approach this would be to use the inverse of the <span>$K$</span> matrix, and  solve the problem as </p><p class="math-container">\[f = K^{-1}g \ .\]</p><p>However the resulting <span>$f$</span> would be terrible for a few reasons:</p><ul><li>Even small amounts of noise in the data would mess up the results due to the very large  <a href="https://en.wikipedia.org/wiki/Condition_number">condition number</a> of the <span>$K$</span> matrix. </li><li>Since there <strong>will</strong> be some amount of noise in <span>$g$</span>, we would not even want our fit  curve (<span>$Kf$</span>) to be exactly equal to the data (<span>$g$</span>), since that would involve fiting  the noise.</li><li>Negative values in <span>$f$</span> would be okay with this method, which does not make much  sense since we can&#39;t have negative amounts of relaxation times  (unless you have a reason to allow that [<a href="../references/#Chand2018">6</a>]).</li></ul><p>This is a textbook example of an <a href="https://en.wikipedia.org/wiki/Inverse_problem">inverse problem</a>.</p><p>The most commmon way to approach it would be <a href="https://en.wikipedia.org/wiki/Ridge_regression#Tikhonov_regularization">Tikhonov regularization</a>, where we solve the following optimization problem : </p><p class="math-container">\[\min_{f \geq 0} \ ||Kf-g||_2^2 + \alpha ||f||_2^2 \ ,\]</p><p>where <span>$\alpha$</span> is a scalar value referred to as the &quot;regularization parameter&quot;.</p><p>This way, we minimize the residuals (<span>$||Kf-g||$</span>) while preventing the norm of the   solution (<span>$||f||$</span>) from getting out of control due to the noise in <span>$g$</span>.</p><p>Low values of <span>$\alpha$</span> would result in noisy, unregularized solutions with spikey <span>$T$</span> or <span>$D$</span> distributions, while large <span>$\alpha$</span>&#39;s would lead to very broad, over- smoothed distributions.</p><p>The <code>invert</code> function in this package solves this problem, and automatically finds the  optimal value for <span>$\alpha$</span> using the GCV method. There is also an option to use the  <code>L-curve</code> method to find <span>$\alpha$</span>, or supply a constant value for it.</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../installation/">« Installation</a><a class="docs-footer-nextpage" href="../tutorial/">Tutorial »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.14.1 on <span class="colophon-date" title="Thursday 4 September 2025 15:17">Thursday 4 September 2025</span>. Using Julia version 1.10.10.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
